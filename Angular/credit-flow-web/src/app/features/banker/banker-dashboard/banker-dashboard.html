<div class="banker-dashboard">
  <!-- Page Header -->
  <div class="page-header">
    <h1 class="page-title">
      <i class="pi pi-briefcase"></i>
      {{ 'bankerDashboard.title' | languagePipe }}
    </h1>
    <p class="page-subtitle">{{ 'bankerDashboard.subtitle' | languagePipe }}</p>
  </div>

  <!-- Statistics Cards -->
  <div class="stats-grid">
    <!-- Total Pending -->
    <p-card pStyleClass="stat-card stat-card-primary">
      <div class="stat-content">
        <div class="stat-icon">
          <i class="pi pi-clock"></i>
        </div>
        <div class="stat-info">
          <span class="stat-label">{{ 'bankerDashboard.stats.pending' | languagePipe }}</span>
          <span class="stat-value">{{ store.pendingLoans().length }}</span>
        </div>
      </div>
    </p-card>

    <!-- Total Amount -->
    <p-card pStyleClass="stat-card stat-card-success">
      <div class="stat-content">
        <div class="stat-icon">
          <i class="pi pi-dollar"></i>
        </div>
        <div class="stat-info">
          <span class="stat-label">{{ 'bankerDashboard.stats.totalVolume' | languagePipe }}</span>
          <span class="stat-value">{{ formatCurrency(store.totalPendingAmount()) }}</span>
        </div>
      </div>
    </p-card>

    <!-- Low Risk Count -->
    <p-card pStyleClass="stat-card stat-card-info">
      <div class="stat-content">
        <div class="stat-icon">
          <i class="pi pi-check-circle"></i>
        </div>
        <div class="stat-info">
          <span class="stat-label">{{ 'bankerDashboard.stats.lowRisk' | languagePipe }}</span>
          <span class="stat-value">{{ store.lowRiskCount() }}</span>
        </div>
      </div>
    </p-card>

    <!-- High Risk Count -->
    <p-card pStyleClass="stat-card stat-card-danger">
      <div class="stat-content">
        <div class="stat-icon">
          <i class="pi pi-exclamation-triangle"></i>
        </div>
        <div class="stat-info">
          <span class="stat-label">{{ 'bankerDashboard.stats.highRisk' | languagePipe }}</span>
          <span class="stat-value">{{ store.highRiskCount() }}</span>
        </div>
      </div>
    </p-card>
  </div>

  <!-- Loans Table -->
  <p-card pStyleClass="loans-card">
    <p-table
      [value]="store.pendingLoans()"
      [loading]="store.isLoading()"
      [paginator]="true"
      [rows]="10"
      [rowsPerPageOptions]="[5, 10, 20]"
      [globalFilterFields]="['applicantName', 'applicantEmail', 'purpose']"
      pStyleClass="loans-table"
      #dt>

      <ng-template #caption>
        <div class="table-header">
          <h3 class="table-title">
            <i class="pi pi-list"></i>
            {{ 'bankerDashboard.table.title' | languagePipe }}
          </h3>
          <span class="p-input-icon-left">
            <i class="pi pi-search"></i>
            <input
              pInputText
              type="text"
              (input)="dt.filterGlobal($any($event.target).value, 'contains')"
              [placeholder]="'bankerDashboard.table.searchPlaceholder' | languagePipe"
              class="search-input" />
          </span>
        </div>
      </ng-template>

      <ng-template #header>
        <tr>
          <th>{{ 'bankerDashboard.table.header.applicant' | languagePipe }}</th>
          <th>{{ 'bankerDashboard.table.header.amount' | languagePipe }}</th>
          <th>{{ 'bankerDashboard.table.header.monthlyPayment' | languagePipe }}</th>
          <th>{{ 'bankerDashboard.table.header.dtiRatio' | languagePipe }}</th>
          <th>{{ 'bankerDashboard.table.header.riskLevel' | languagePipe }}</th>
          <th>{{ 'bankerDashboard.table.header.submitted' | languagePipe }}</th>
          <th class="center-actions">{{ 'bankerDashboard.table.header.actions' | languagePipe }}</th>
        </tr>
      </ng-template>

      <ng-template #body let-loan>
        <tr>
          <!-- Applicant Info -->
          <td>
            <div class="applicant-info">
              <span class="applicant-name">{{ loan.applicantName }}</span>
              <span class="applicant-email">{{ loan.applicantEmail }}</span>
              <span class="applicant-employer">
                <i class="pi pi-building"></i>
                {{ loan.employerName }}
              </span>
            </div>
          </td>

          <!-- Amount -->
          <td>
            <div class="amount-info">
              <span class="amount-value">{{ formatCurrency(loan.amount) }}</span>
              <span class="amount-term">{{ loan.termMonths }} {{ 'bankerDashboard.termMonths' | languagePipe }} @ {{ formatPercent(loan.interestRate) }}</span>
            </div>
          </td>

          <!-- Monthly Payment -->
          <td>
            <span class="monthly-payment">{{ formatCurrency(loan.monthlyPayment) }}{{ 'bankerDashboard.perMonth' | languagePipe }}</span>
          </td>

          <!-- DTI Ratio -->
          <td>
            <span class="dti-ratio" [class.high-dti]="loan.debtToIncomeRatio > 43">
              {{ formatPercent(loan.debtToIncomeRatio) }}
            </span>
          </td>

          <!-- Risk Level -->
          <td>
            <p-tag
              [value]="loan.riskLevel"
              [severity]="getRiskSeverity(loan.riskLevel)" />
          </td>

          <!-- Submitted Date -->
          <td>
            <span class="submitted-date">{{ formatDate(loan.submittedOn) }}</span>
          </td>

          <!-- Actions -->
          <td>
            <div class="action-buttons">
              <p-button
                icon="pi pi-eye"
                (onClick)="viewDetails(loan)"
                [text]="true"
                [rounded]="true"
                severity="info"
                [pTooltip]="'bankerDashboard.tooltip.viewDetails' | languagePipe"
                tooltipPosition="top" />

              <p-button
                icon="pi pi-check"
                (onClick)="openApproveDialog(loan)"
                [text]="true"
                [rounded]="true"
                severity="success"
                [pTooltip]="'bankerDashboard.tooltip.approve' | languagePipe"
                tooltipPosition="top" />

              <p-button
                icon="pi pi-times"
                (onClick)="openRejectDialog(loan)"
                [text]="true"
                [rounded]="true"
                severity="danger"
                [pTooltip]="'bankerDashboard.tooltip.reject' | languagePipe"
                tooltipPosition="top" />
            </div>
          </td>
        </tr>
      </ng-template>

      <ng-template #emptymessage>
        <tr>
          <td colspan="7" class="empty-state">
            <div class="empty-content">
              <i class="pi pi-inbox"></i>
              <h4>{{ 'bankerDashboard.empty.title' | languagePipe }}</h4>
              <p>{{ 'bankerDashboard.empty.subtitle' | languagePipe }}</p>
            </div>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </p-card>

  <!-- Loan Details Dialog -->
  <p-dialog
    [(visible)]="showDetailsDialog"
    [header]="'bankerDashboard.dialog.detailsTitle' | languagePipe"
    [modal]="true"
    [style]="{ width: '800px' }"
    [draggable]="false"
    [resizable]="false">

    @if (selectedLoan(); as loan) {
      <div class="loan-review">
        <!-- Applicant Section -->
        <div class="review-section">
          <h4 class="section-title">
            <i class="pi pi-user"></i>
            {{ 'bankerDashboard.section.applicant' | languagePipe }}
          </h4>
          <div class="detail-grid">
            <div class="detail-item">
              <span class="detail-label">{{ 'bankerDashboard.label.name' | languagePipe }}</span>
              <span class="detail-value">{{ loan.applicantName }}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">{{ 'bankerDashboard.label.email' | languagePipe }}</span>
              <span class="detail-value">{{ loan.applicantEmail }}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">{{ 'bankerDashboard.label.employer' | languagePipe }}</span>
              <span class="detail-value">{{ loan.employerName }}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">{{ 'bankerDashboard.label.jobTitle' | languagePipe }}</span>
              <span class="detail-value">{{ loan.jobTitle }}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">{{ 'bankerDashboard.label.yearsEmployed' | languagePipe }}</span>
              <span class="detail-value">{{ loan.yearsEmployed }} {{ 'bankerDashboard.years' | languagePipe }}</span>
            </div>
          </div>
        </div>

        <!-- Financial Section -->
        <div class="review-section">
          <h4 class="section-title">
            <i class="pi pi-chart-line"></i>
            {{ 'bankerDashboard.section.financial' | languagePipe }}
          </h4>
          <div class="detail-grid">
            <div class="detail-item">
              <span class="detail-label">{{ 'bankerDashboard.label.monthlyIncome' | languagePipe }}</span>
              <span class="detail-value highlight-success">{{ formatCurrency(loan.monthlyIncome) }}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">{{ 'bankerDashboard.label.monthlyExpenses' | languagePipe }}</span>
              <span class="detail-value">{{ formatCurrency(loan.monthlyExpenses) }}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">{{ 'bankerDashboard.label.netCashFlow' | languagePipe }}</span>
              <span class="detail-value" [class.text-danger]="loan.monthlyIncome - loan.monthlyExpenses - loan.monthlyPayment < 0">
                {{ formatCurrency(loan.monthlyIncome - loan.monthlyExpenses - loan.monthlyPayment) }}
              </span>
            </div>
          </div>
        </div>

        <!-- Loan Details Section -->
        <div class="review-section">
          <h4 class="section-title">
            <i class="pi pi-dollar"></i>
            {{ 'bankerDashboard.section.loanDetails' | languagePipe }}
          </h4>
          <div class="detail-grid">
            <div class="detail-item">
              <span class="detail-label">{{ 'bankerDashboard.label.requestedAmount' | languagePipe }}</span>
              <span class="detail-value highlight-primary">{{ formatCurrency(loan.amount) }}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">{{ 'bankerDashboard.label.term' | languagePipe }}</span>
              <span class="detail-value">{{ loan.termMonths }} {{ 'bankerDashboard.termMonths' | languagePipe }}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">{{ 'bankerDashboard.label.interestRate' | languagePipe }}</span>
              <span class="detail-value">{{ formatPercent(loan.interestRate) }} {{ 'bankerDashboard.apr' | languagePipe }}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">{{ 'bankerDashboard.label.monthlyPayment' | languagePipe }}</span>
              <span class="detail-value highlight-primary">{{ formatCurrency(loan.monthlyPayment) }}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">{{ 'bankerDashboard.label.totalInterest' | languagePipe }}</span>
              <span class="detail-value">{{ formatCurrency(loan.totalInterest) }}</span>
            </div>
            <div class="detail-item">
              <span class="detail-label">{{ 'bankerDashboard.label.totalCost' | languagePipe }}</span>
              <span class="detail-value font-semibold">{{ formatCurrency(loan.amount + loan.totalInterest) }}</span>
            </div>
            <div class="detail-item full-width">
              <span class="detail-label">{{ 'bankerDashboard.label.purpose' | languagePipe }}</span>
              <p class="detail-description">{{ loan.purpose }}</p>
            </div>
          </div>
        </div>

        <!-- Risk Assessment Section -->
        <div class="review-section risk-section">
          <h4 class="section-title">
            <i class="pi pi-shield"></i>
            {{ 'bankerDashboard.section.riskAssessment' | languagePipe }}
          </h4>
          <div class="risk-grid">
            <div class="risk-metric">
              <span class="metric-label">{{ 'bankerDashboard.risk.dtiRatio' | languagePipe }}</span>
              <span class="metric-value" [class.text-danger]="loan.debtToIncomeRatio > 43">
                {{ formatPercent(loan.debtToIncomeRatio) }}
              </span>
              <span class="metric-status" [class.text-danger]="loan.debtToIncomeRatio > 43">
                {{ loan.debtToIncomeRatio > 43
                  ? ('bankerDashboard.risk.aboveThreshold' | languagePipe)
                  : ('bankerDashboard.risk.withinRange' | languagePipe) }}
              </span>
            </div>
            <div class="risk-metric">
              <span class="metric-label">{{ 'bankerDashboard.risk.riskLevel' | languagePipe }}</span>
              <p-tag
                [value]="loan.riskLevel"
                [severity]="getRiskSeverity(loan.riskLevel)"
                pStyleClass="risk-tag" />
            </div>
          </div>
        </div>
      </div>
    }

    <ng-template #footer>
      <div class="dialog-footer">
        <p-button
          [label]="'bankerDashboard.dialog.close' | languagePipe"
          (onClick)="closeDetailsDialog()"
          severity="secondary"
          [outlined]="true" />
        @if (selectedLoan(); as loan) {
          <p-button
            [label]="'bankerDashboard.dialog.reject' | languagePipe"
            icon="pi pi-times"
            (onClick)="closeDetailsDialog(); openRejectDialog(loan)"
            severity="danger"
            [outlined]="true" />
          <p-button
            [label]="'bankerDashboard.dialog.approve' | languagePipe"
            icon="pi pi-check"
            (onClick)="closeDetailsDialog(); openApproveDialog(loan)"
            severity="success" />
        }
      </div>
    </ng-template>
  </p-dialog>

  <!-- Decision Dialog -->
  <p-dialog
    [(visible)]="showDecisionDialog"
    [header]="decisionType() === 'approve'
      ? ('bankerDashboard.decision.title.approve' | languagePipe)
      : ('bankerDashboard.decision.title.reject' | languagePipe)"
    [modal]="true"
    [style]="{ width: '500px' }"
    [draggable]="false"
    [resizable]="false">

    @if (selectedLoan(); as loan) {
      <div class="decision-content">
        <div class="decision-info">
          @if (decisionType() === 'approve') {
            <div class="approval-message">
              <i class="pi pi-check-circle"></i>
              <p>{{ 'bankerDashboard.decision.message.approve' | languagePipe }} <strong>{{ loan.applicantName }}</strong>.</p>
              <ul>
                <li>{{ 'bankerDashboard.decision.label.amount' | languagePipe }} <strong>{{ formatCurrency(loan.amount) }}</strong></li>
                <li>{{ 'bankerDashboard.decision.label.monthlyPayment' | languagePipe }} <strong>{{ formatCurrency(loan.monthlyPayment) }}</strong></li>
                <li>{{ 'bankerDashboard.decision.label.riskLevel' | languagePipe }} <p-tag [value]="loan.riskLevel" [severity]="getRiskSeverity(loan.riskLevel)" /></li>
              </ul>
            </div>
          } @else {
            <div class="rejection-message">
              <i class="pi pi-exclamation-triangle"></i>
              <p>{{ 'bankerDashboard.decision.message.reject' | languagePipe }} <strong>{{ loan.applicantName }}</strong>.</p>
              <p class="warning-text">{{ 'bankerDashboard.decision.warning.reject' | languagePipe }}</p>
            </div>
          }
        </div>

        <form [formGroup]="decisionForm">
          <div class="field">
            <label for="comments" class="field-label">
              <i class="pi pi-comment"></i>
              {{ 'bankerDashboard.decision.commentsLabel' | languagePipe }}
            </label>
            <textarea
              id="comments"
              pTextarea
              formControlName="comments"
              rows="5"
              class="w-full"
              [placeholder]="decisionType() === 'approve'
                ? ('bankerDashboard.decision.commentsPlaceholderApprove' | languagePipe)
                : ('bankerDashboard.decision.commentsPlaceholderReject' | languagePipe)"></textarea>
            @if (decisionForm.get('comments')?.dirty && decisionForm.get('comments')?.invalid) {
              <small class="p-error block mt-1">
                {{ 'bankerDashboard.decision.commentsError' | languagePipe }}
              </small>
            }
          </div>
        </form>
      </div>
    }

    <ng-template #footer>
      <p-button
        [label]="'bankerDashboard.decision.cancel' | languagePipe"
        (onClick)="closeDecisionDialog()"
        severity="secondary"
        [outlined]="true" />
      <p-button
        [label]="decisionType() === 'approve'
          ? ('bankerDashboard.decision.confirmApprove' | languagePipe)
          : ('bankerDashboard.decision.confirmReject' | languagePipe)"
        [icon]="decisionType() === 'approve' ? 'pi pi-check' : 'pi pi-times'"
        (onClick)="submitDecision()"
        [severity]="decisionType() === 'approve' ? 'success' : 'danger'"
        [disabled]="decisionForm.invalid" />
    </ng-template>
  </p-dialog>

  <p-toast />
  <p-confirmDialog />
</div>
